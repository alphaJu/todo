<html>
  <head>
    <title>Todo</title>
    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
</script>
  </head>
  <body>
    <div>
      <h2>Todo List</h2>
      <input type="text" id="title" name="title" placeholder="title">
      <input type="test" id="content" name="content" placeholder="content">
      <select id="priority" name="priority">
        <option value=""></option>
        <option value="!">!</option>
        <option value="!!">!!</option>
        <option value="!!!">!!!</option>
      </select>
      <input type="date" id="dueDate" name="dueDate">
      <button onclick="postTodo();">ADD</button>
      <button onclick="expired();">EXPIRED</button>
    </div>
    <div>
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>Content</th>
            <th>DueDate</th>
            <th>Priority</th>
            <th>Done</th>
            <th>Mod/Del</th>
          </tr>
        </thead>
        <tbody>
          <% for(var i = 0; i < result.length; i++) {var todo = result[i];%>
            <tr>
              <td>
                <input type="text" id="<%=todo._id%>title" name="title" value=<%=todo.title%>>
                </td>
              <td>
                <input type="text" id="<%=todo._id%>content" name="content" value=<%=todo.content%>>
              </td>
              <td>
                <input type="date" id="<%=todo._id%>dueDate" name="dueDate" value=<%=todo.date%>>
              </td>
              <td>
                <select id="<%=todo._id%>priority" name="priority">
                  <option value="" <% if(todo.priority==="") { %>selected<%}%> ></option>
                  <option value="!" <% if(todo.priority==="!") { %>selected<%}%> >!</option>
                  <option value="!!" <% if(todo.priority==="!!") { %>selected<%}%> >!!</option>
                  <option value="!!!" <% if(todo.priority==="!!!") { %>selected<%}%> >!!!</option>
                </select>
              </td>
              <td>
                <input type="checkbox" id="<%=todo._id%>done" name="done" <% if(todo.done!=="0") {%>checked<%}%>>Done
              </td>
              <td>
                <button onclick="modifyTodo('<%=todo._id%>');">MOD</button>
                <button onclick="deleteTodo('<%=todo._id%>');">DEL</button>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </body>
  <script>
  function expired() {
    let alerts = <%- JSON.stringify(expired) %>
    let message = "These are expired.\n\n";
    alerts.forEach((alert) => {
      message += alert.title + " : " + alert.content + " was expired at " + alert.date + "\n";
    })
    alert(message);
  }

  function modifyTodo(_id) {
    let isDone = "0";
    if ($('#'+_id+'done').is(":checked")) isDone = "1";
    console.log(isDone+"sdfadsf")
    $.ajax({
      url: '/todo',
      data: {todoId:_id, title:$('#'+_id+'title').val(), content:$('#'+_id+'content').val(),
        priority:$('#'+_id+'priority').val(), dueDate:$('#'+_id+'dueDate').val(),
        done:isDone
        },
      type: 'PUT',
      success: function(result) {
        console.log(result.message);
        window.location='/'
      },
      error: function(request, status, error) {
        console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
      }
    });
  }

  function deleteTodo(_id) {
    $.ajax({
      url: '/todo',
      data: {todoId:_id},
      type: 'DELETE',
      success: function(result) {
        console.log(result.message);
        window.location='/'
      },
      error: function(request, status, error) {
        console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
      }
    });
  }

  function postTodo() {
    console.log($('#title').val());
    $.ajax({
      url: '/todo',
      data: {title:$('#title').val(), content:$('#content').val(),
        priority:$('#priority').val(), dueDate:$('#dueDate').val()
        },
      type: 'POST',
      success: function(result) {
        console.log(result.message);
        window.location='/'
      },
      error: function(request, status, error) {
        console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
      }
    });
  }
  </script>
</html>
